<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #202124; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .video-container { display: flex; gap: 20px; margin: 20px 0; }
        video { width: 300px; height: 200px; background: #000; border: 2px solid #40a7e3; }
        button { padding: 10px 20px; margin: 5px; background: #40a7e3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .log { background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC Connection Test</h1>
        
        <div>
            <input id="username" placeholder="Your name" style="padding: 10px; margin: 5px;">
            <input id="room" placeholder="Room name" style="padding: 10px; margin: 5px;">
            <button onclick="joinRoom()">Join Room</button>
            <button onclick="startVideo()">Start Video</button>
        </div>
        
        <div class="video-container">
            <div>
                <h3>Local Video</h3>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div>
                <h3>Remote Video</h3>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        let localStream, pc, myId, myName, myRoom;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        socket.on('connect', () => {
            myId = socket.id;
            log('üü¢ Connected to server: ' + myId);
        });
        
        socket.on('room_joined', (data) => {
            log('üè† Joined room: ' + data.room);
        });
        
        socket.on('user_joined', (data) => {
            log('üë§ User joined: ' + data.user + ' (' + data.sid + ')');
        });
        
        socket.on('user_video_started', async (data) => {
            log('üé• User started video: ' + data.user);
            if (data.sid !== myId) {
                await createOffer(data.sid);
            }
        });
        
        socket.on('offer', async (data) => {
            log('üì• Received offer from: ' + data.from);
            await handleOffer(data);
        });
        
        socket.on('answer', async (data) => {
            log('üì• Received answer from: ' + data.from);
            await pc.setRemoteDescription(data.answer);
        });
        
        socket.on('ice_candidate', async (data) => {
            log('üì• Received ICE candidate from: ' + data.from);
            await pc.addIceCandidate(data.candidate);
        });
        
        function joinRoom() {
            myName = document.getElementById('username').value;
            myRoom = document.getElementById('room').value;
            if (!myName || !myRoom) return alert('Enter name and room');
            
            socket.emit('join_room', {username: myName, room: myRoom});
            log('üîÑ Joining room: ' + myRoom + ' as ' + myName);
        }
        
        async function startVideo() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('localVideo').srcObject = localStream;
                socket.emit('video_started');
                log('üé• Started local video');
            } catch (err) {
                log('‚ùå Error accessing camera: ' + err.message);
            }
        }
        
        async function createOffer(targetId) {
            try {
                pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]});
                
                if (localStream) {
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }
                
                pc.ontrack = (event) => {
                    log('üì∫ Received remote stream');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice_candidate', {target: targetId, candidate: event.candidate});
                    }
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('offer', {target: targetId, offer: offer});
                log('üì§ Sent offer to: ' + targetId);
            } catch (err) {
                log('‚ùå Error creating offer: ' + err.message);
            }
        }
        
        async function handleOffer(data) {
            try {
                pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]});
                
                if (localStream) {
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }
                
                pc.ontrack = (event) => {
                    log('üì∫ Received remote stream');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice_candidate', {target: data.from, candidate: event.candidate});
                    }
                };
                
                await pc.setRemoteDescription(data.offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('answer', {target: data.from, answer: answer});
                log('üì§ Sent answer to: ' + data.from);
            } catch (err) {
                log('‚ùå Error handling offer: ' + err.message);
            }
        }
    </script>
</body>
</html>
